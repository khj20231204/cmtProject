<!DOCTYPE html>
<!-- Thymeleaf 및 레이아웃 선언 - 레이아웃 구조를 사용하기 위한 필수 선언 -->
	<html xmlns:th="http://www.thymeleaf.org" 
	      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
	      layout:decorate="~{layouts/layout}">
<head>
    <!-- 기본 메타 정보 -->
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<!-- xlsx.js (필수 의존성) -->
	<!-- <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>-->
	<!-- 최신 xlsx 스크립트 CDN -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
	<title>CMT</title>
<style>
    /* 상단 입력 그룹: 검색 및 버튼들을 가로로 배치하며 필요시 줄바꿈 허용 */
    .top-input-group {
        display: flex; /* 플렉스박스로 배치 */
        align-items: flex-start; /* 위쪽 정렬 */
        justify-content: space-between; /* 좌우 여백 최대 */
        flex-wrap: wrap; /* 요소가 넘칠 경우 줄바꿈 */
        gap: 10px; /* 요소 간 간격 */
        margin-bottom: 15px; /* 하단 여백 */
    }

    /* 검색 및 파일 관련 그룹: 가로 배치, 줄바꿈 가능 */
    .search-file-group {
        display: flex;
        align-items: center; /* 수직 정렬 */
        gap: 8px; /* 요소 간 여백 */
        flex-wrap: wrap; /* 줄바꿈 허용 */
        flex: 1 1 auto; /* 공간을 적절히 차지하도록 설정 */
        min-width: 500px; /* 최소 너비 확보 (줄바꿈 방지) */
    }

    /* CRUD 버튼 그룹: 버튼을 가로로 배치, 줄바꿈 허용 */
    .button-group {
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
    }

    /* 일반 입력창 스타일: 최대 너비 설정, 반응형 대응 */
    .form-control {
        max-width: 200px; /* 최대 너비 제한 */
        flex: 0 1 auto; /* 내용에 따라 너비 조절 */
    }

    /* 파일 업로드 입력창 스타일 */
    .file-input {
        max-width: 280px;
        flex: 0 1 auto;
    }

    /* 엑셀 업로드/다운로드 버튼 스타일 */
    .btn-excel {
        background-color: #1D6F42; /* 녹색 배경 */
        color: white; /* 흰색 텍스트 */
        white-space: nowrap; /* 버튼 텍스트 줄바꿈 방지 */
    }

    /* 엑셀 버튼 호버 시 스타일 */
    .btn-excel:hover {
        background-color: #15562F; /* 더 어두운 녹색 */
        color: white;
    }

    /* 테이블 전체 스타일 */
    .table {
        table-layout: fixed; /* 열 너비 고정 */
        width: 100%; /* 부모 너비에 맞춤 */
    }

    /* 테이블 스크롤 영역 */
/*     .table-responsive { */
/*         height: 530px; /* 높이 고정 */ */
/*         overflow: auto; /* 스크롤 활성화 */ */
/*         -webkit-overflow-scrolling: touch; /* 모바일 스크롤 개선 */ */
/*     } */

    /* 첫 번째 열(선택 체크박스)의 너비와 정렬 */
    th:first-child,
    td:first-child {
        width: 40px;
        text-align: center;
    }

    /* TOAST UI Grid의 비활성 셀 스타일 */
    .tui-grid-cell-disabled {
        background-color: #fff !important;
        color: #212529 !important;
    }

    /* 반응형: 화면이 좁을 때의 처리 */
    @media (max-width: 768px) {
        .top-input-group {
            flex-direction: column; /* 세로로 배치 */
            align-items: flex-start; /* 왼쪽 정렬 */
        }

        .search-file-group,
        .button-group {
            width: 100%; /* 전체 너비 사용 */
            margin-bottom: 10px; /* 하단 여백 */
        }
    }
</style>	
</head>
<body>
	<div layout:fragment="content">
	<h3>제조 계획</h3>
	
		<!-- 제조 계획 정보 섹션 -->
		<section class="section">
			<div class="row" id="basic-table">
				<!-- 제조 계획 정보 그리드 카드 -->
				<div class="col-12 col-md-12">
					<div class="card">
						<div class="card-header">
							<h4 class="card-title">제조 계획</h4>

							<!-- 검색, 파일 업로드, 엑셀 및 CRUD 버튼 -->
							<div class="top-input-group">
								<!-- 왼쪽: 검색 및 엑셀 관련 -->
								<div class="search-file-group">
									<input type="text" class="form-control" id="searchInput"
										placeholder="제조 계획 검색">
									<button type="button" id="msSearchBtn" class="btn btn-outline-primary">
										<i class="bi bi-search"></i>
									</button>

									<!-- 로그인한 사용자 ID -->
									<input type="hidden" id="currentUserId" th:value="${#authentication.name}" />

									<!-- 엑셀 파일 입력 및 버튼 -->
									<button type="button" id="ExcelDownBtn" class="btn btn-excel">
										<i class="bi bi-file-earmark-arrow-down"></i> 엑셀 다운로드
									</button>
								</div>

								<!-- 오른쪽: CRUD 버튼 -->
								<div class="button-group">
									<button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#mfgScheduleModal">제조 계획 등록</button>
									<button type="button" id="msSaveBtn" class="btn btn-outline-success">저장</button>
									<button type="button" id="msDeleteBtn" class="btn btn-outline-danger">삭제</button>
								</div>
							</div>
						</div>
						<div class="card-body">
							<div class="table-responsive">
								<!-- 제조 계획 그리드 -->
								<div id="mfgScheduleGrid"></div>
								<!-- 제조 상세 계획 그리드 -->
								<h5>제조 상세 계획</h5>
								<div id="msDetailGrid"></div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</section>
		
	<!--  모달 창 시작 -->
	<div class="modal fade" id="mfgScheduleModal" tabindex="-1" aria-labelledby="mfgScheduleModalLabel" aria-hidden="true">
	    <div class="modal-dialog modal-full">
	        <div class="modal-content">
	            <div class="modal-header">
	                <h5 class="modal-title" id="mfgScheduleModalLabel">제조 계획 등록</h5>
	                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
	            </div>
	            <div class="modal-body">
	            	<div id="mpGrid"></div>
				</div>
	            <div class="modal-footer">
	                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
	                <button type="button" id="mfgScheduleRegiBtn" class="btn btn-primary">등록</button>
		        </div>
	        </div> <!-- modal-content -->
	    </div><!-- modal-dialog modal-lg -->
	</div><!-- modal -->
	<!-- 모달 끝 -->

		<!-- 
        페이지별 JavaScript 추가 영역.
        여기에 페이지에서 사용할 스크립트를 작성하세요.
        공통 스크립트는 레이아웃에서 자동으로 포함됩니다.
    -->	
	<script th:inline="javascript">
	
	//================================== 그리드 상단 부분 ================================= 
	let msList = /*[[${msList}]]*/ [];
	
	let grid = new tui.Grid({
        el: document.getElementById('mfgScheduleGrid'), 
		data: msList,
        rowHeaders: ['checkbox'], 
		scrollX: true,
        scrollY: true,
		pageOptions: {
		   useClient: true,   // 클라이언트 사이드 페이징 사용
		   perPage: 10        // 페이지당 행 수
		 },
        columns: [
			{
				header: '제조계획번호',
				name: 'msNo',
				width: 100,
				sortable: true, 
				filter: 'text',
				align: "center" 
            },
			{
				header: '제조계획코드',
				name: 'msCode',
				width: 200,
				sortable: true, 
				filter: 'text',
				align: "center" 
            },
           {
                header: '생산계획코드',
                name: 'mpCode',
				width: 200,
				sortable: true, 
				filter: 'text',
				align: "center" 
            },
            {
				header: '제조계획상태',
                name: 'msStatus',
				width: 150,
				sortable: true, 
				filter: 'text',
				align: 'center',
				editor: false
            },
			{
                header: '우선순위',
                name: 'mpPriority',
				width: 150,
				sortable: true, 
				filter: 'text',
				align: 'center',
				editor: false
            },
			{
                header: '제품코드',
                name: 'pdtCode',
				width: 150,
				fontSize: '40',
				sortable: true, 
				filter: 'text',
				align: 'center',
				editor: false
            },
			{
                header: '제품명',
                name: 'pdtName',
				width: 150,
				fontSize: '40',
				sortable: true, 
				filter: 'text',
				align: 'center',
				editor: false
            },
            {
				header: '주문수량',
                name: 'soQty',
				width: 100,
				sortable: true, 
				filter: 'text',
				align: 'center',
				editor: false
            },
            {
                header: '주문단위',
                name: 'qtyUnitName',
				width: 100,
				sortable: true, 
				filter: 'text',
				align: "center" 
            },
			{
                header: '등록사원번호',
                name: 'empId',
				width: 100,
				sortable: true, 
				filter: 'text',
				align: "center",
				editor: false
            },
			{
                header: '등록사원명',
                name: 'empName',
				width: 100,
				sortable: true, 
				filter: 'text',
				align: "center",
				editor: false
            },
			{
                header: '등록일자',
                name: 'msCreatedAt',
				width: 200,
				sortable: true, 
				filter: 'text',
				align: 'center',
				editor: {
					type: 'datePicker',
					options: {
						format: 'yyyy-MM-dd'
					}
				}
            },
			{
                header: '수정일자',
                name: 'msUpdatedAt',
				width: 200,
				sortable: true, 
				filter: 'text',
				align: 'center',
				editor: {
					type: 'datePicker',
					options: {
						format: 'yyyy-MM-dd'
					}
				}
            }
        ], // 열 설정
		autoEdit: true,
		editingEvent: 'dblclick' 
    });

	
	let selectedEv = null;
	
	//클릭시 제품 선택 값의 BOM을 하단 그리드에 출력
	grid.on('click', ev => {
		if(selectedEv !== null){
			grid.removeRowClassName(selectedEv.rowKey, 'selectedRowClass');
		}
		
		selectedEv = ev;
		grid.addRowClassName(selectedEv.rowKey, 'selectedRowClass');
		
		//클릭해서 하단 제조 계획 상세에 선택된 제조 정보 출력
		let evValue = ev;

		let rk = evValue.rowKey;
		let rowData = grid.getRow(rk);
		let msCode = rowData.msCode;
		console.log("선택한 제조계획번호(msCode): ", msCode);
		// 제조 계획 그리드에서 선택된 제품에 해당하는 제조 계획 상세 데이터 불러오기
		$.ajax({
		url: `/ms/detail`, 
        type: 'GET',
        data: { msCode: msCode },
        success: function (response) {
        	console.log("서버 응답 전체:", response);
			if (response.success) {
				const msData = response.data;
				 console.log("msData만 따로:", msData);
				msDetailGrid.resetData(msData);
			} else {
				alert("상세정보를 불러오지 못했습니다.");
			}
		},
		error: function (err) {
			console.error("제조 계획 상세 데이터 로딩 실패", err);
		}
		});
	});
    	
	//================================== 그리드 하단 bom 부분 =================================
	
	let msdList = /*[[${msdList}]]*/ [];
	console.log("디테일확인염", msdList);
	
		let msDetailGrid = new tui.Grid({
        el: document.getElementById('msDetailGrid'), 
		data: msdList,
        rowHeaders: ['checkbox'], 
		scrollX: true,
        scrollY: true,
		pageOptions: {
		   useClient: true,   // 클라이언트 사이드 페이징 사용
		   perPage: 10        // 페이지당 행 수
		 },
        columns: [
			{
				header: '제조상세번호',
				name: 'MSD_NO',
				width: 100,
				sortable: true, 
				filter: 'text',
				align: "center" 
            },
			{
				header: '제조계획코드',
				name: 'MS_CODE',
				width: 100,
				sortable: true, 
				filter: 'text',
				align: "center" 
            },
           {
                header: '제품 코드',
                name: 'PARENT_PDT_CODE',
				width: 200,
				sortable: true, 
				filter: 'text',
				align: "center" 
            },
            {
                header: '제품명',
                name: 'PDT_NAME',
				width: 200,
				sortable: true, 
				filter: 'text',
				align: "center" 
            },
			{
                header: '코드 유형',
                name: 'ITEM_TYPE',
				width: 200,
				fontSize: '40',
				sortable: true, 
				filter: 'text',
				align: 'center',
				formatter: function({ value }) {
			        if (value === 'SEMI_FINISHED') {
			            return '반제품';
			        } else if (value === 'RAW_MATERIAL') {
			            return '완제품';
			        } else {
			            return value; // 혹시 다른 값이 들어오면 원래 값 표시
			        }
			    }
				
            },
			{
                header: '계획수량',
                name: 'MS_QTY',
				width: 200,
				sortable: true, 
				filter: 'text',
				align: "center",
				editor: "text"
            },
            {
				header: '투입단위',
                name: 'QTYUNITNAME',
				width: 200,
				sortable: true, 
				filter: 'text',
				align: 'center',
				editor: "text"
            }
        ], // 열 설정
		autoEdit: true,
		editingEvent: 'dblclick' 
    });	
		
		msDetailGrid.on('onGridUpdated', (ev) => {
			// 그리드 레이아웃 새로고침 (로드가 다 되지 않는 경우 그리드가 흰색 화면으로 출력될 때가 있다.)
		    msDetailGrid.refreshLayout();
		});
		
		let selectedEv2 = null;
		msDetailGrid.on('click', (ev) => {
			if(selectedEv2 !== null){
				msDetailGrid.removeRowClassName(selectedEv2.rowKey, 'selectedRowClass');
			}
			
			selectedEv2 = ev;
			msDetailGrid.addRowClassName(selectedEv2.rowKey, 'selectedRowClass');
		})
	
		
	/*
	grid.on('onGridUpdated', (ev) => {
		// 그리드 레이아웃 새로고침 (로드가 다 되지 않는 경우 그리드가 흰색 화면으로 출력될 때가 있다.)
	    grid.refreshLayout();
	});*/
	
	
	// 제조 계획 등록 시 생산 계획 그리드
	let mpList = /*[[${mpList}]]*/ [];
	console.log("-----------------확인", mpList);
	let grid2 = null;	
		
	document.getElementById('mfgScheduleModal').addEventListener('shown.bs.modal', () => {
		if (!grid2) {	
			grid2 = new tui.Grid({
				el: document.getElementById('mpGrid'), 
				data : mpList,
				rowHeaders: ['checkbox'],
				pageOptions: {
					useClient: true,
					perPage: 5
				},
				columns: [
					{
						header: '상품계획코드',
						name: 'mpCode',
						sortable: true,
						align: "center"
					},
					{
						header: '등록직원사번',
						name: 'empId',
						sortable: true,
						align: "center"
					},
					{
						header: '등록직원명',
						name: 'empName',
						sortable: true,
						align: "center"
					},				
					{
						header: '제품코드',
						name: 'pdtCode',
						sortable: true,
						align: "center"
					},
					{
						header: '제품명',
						name: 'pdtName', 
						sortable: true,
						align: "center"
					},
					{
						header: '주문수량',
						name: 'soQty',
						sortable: true,
						align: "center"
					},
					{
						header: '주문단위',
						name: 'qtyUnitName',
						sortable: true,
						align: "center"
					},
					{
						header: '우선순위',
						name: 'mpPriority', 
						sortable: true,
						align: "center"
					},
					{
						header: '생산 시작 예정일',
						name: 'mpStartDate',
						sortable: true,
						align: "center",
						editor: {
							type: 'datePicker',
							options: {
								format: 'yyyy-MM-dd'
							}
						}
					},
					{
						header: '생산 완료 예정일',
						name: 'mpEndDate', 
						sortable: true,
						align: "center",
						editor: {
							type: 'datePicker',
							options: {
								format: 'yyyy-MM-dd'
							}
						}
					}
				]
			});
		}	
	});
	
	//제조 계획 등록 시작 -------------------------------------------
	$('#mfgScheduleRegiBtn').on('click', async function () {
		// 로그인한 유저 정보
		const empId = document.getElementById('currentUserId')?.value;
	
		const checkedRows = grid2.getCheckedRows(); // 선택된 행 가져오기
	
		const dataList = checkedRows.map((row, index) => ({
	        ...row,
	        empId: empId
	    }));
		
		$.ajax({
			url: "/ms/mfgScheduleRegi",
			method : "POST",
			contentType: "application/json",
			data: JSON.stringify(dataList), // JSON 문자열로 전송
			success : function (response){
				alert(response);
				location.reload();
			},
			error : function (error){
				console.log(error);
			}
		})
	});
	// 제조 계획 등록 끝---------------------------------------------------------	
	
    //그리드 -> 엑셀 파일로 다운로드
	document.getElementById('ExcelDownBtn').addEventListener('click', function () {
	    
		//현재 그리드 데이터 가져오기
		const gridData = msDetailGrid.getData();
		
		//현재 그리드의 컬럼 값 가져오기
	    const columns = msDetailGrid.getColumns();

		//컬럼을 header와 name으로 분리
	    const header = columns.map(col => col.header);
	    const keys = columns.map(col => col.name);

		//header만큼 배열 생성
	    const exportData = [header];

		//row값을 데이터에 저장
	    gridData.forEach(row => {
	        const rowData = keys.map(key => row[key]);
	        exportData.push(rowData);
	    });

		//CDN 이용
	    const worksheet = XLSX.utils.aoa_to_sheet(exportData);
	    const workbook = XLSX.utils.book_new();

	    XLSX.utils.book_append_sheet(workbook, worksheet, 'Sheet1');
	    XLSX.writeFile(workbook, 'MFG-PLAN-grid-data.xlsx');
	});
	
	let file;
	let reader;

	//버튼 클릭 시 선택된 엑셀 파일을 그리드에 출력
	document.getElementById('ExcelUpBtn').addEventListener('click', function (e) {
		
		if (!file) {
			document.getElementById('fileInput').click();
	        return;
	    }
		
		reader.onload = function (event) {
			const data = new Uint8Array(event.target.result);
		    const workbook = XLSX.read(data, { type: 'array' });

			const firstSheetName = workbook.SheetNames[0];
		    const worksheet = workbook.Sheets[firstSheetName];

			console.log(worksheet);
			
			worksheet["A1"] = { t: "s", v: "msdNo", r:"<t>mpNo</t><phoneticPr fontId='1' type='noConversion'/>", h: 'msdNo', w: 'msdNo' };
			worksheet["B1"] = { t: "s", v: "msCode", r:"<t>mpCode</t><phoneticPr fontId='1' type='noConversion'/>", h: 'msCode', w: 'msCode' };  			
			worksheet["D1"] = { t: "s", v: "parentPdtCode", r:"<t>iqcCode</t><phoneticPr fontId='1' type='noConversion'/>", h: 'parentPdtCode', w: 'parentPdtCode' };
			worksheet["E1"] = { t: "s", v: "pdtName", r:"<t>empId</t><phoneticPr fontId='1' type='noConversion'/>", h: 'pdtName', w: 'pdtName' };
			worksheet["F1"] = { t: "s", v: "itemType", r:"<t>mpStatus</t><phoneticPr fontId='1' type='noConversion'/>", h: 'itemType', w: 'itemType' };
			worksheet["G1"] = { t: "s", v: "msQty", r:"<t>mpPriority</t><phoneticPr fontId='1' type='noConversion'/>", h: 'msQty', w: 'msQty' };
			worksheet["H1"] = { t: "s", v: "qtyUnitName", r:"<t>mpCreatedAt</t><phoneticPr fontId='1' type='noConversion'/>", h: 'qtyUnitName', w: 'qtyUnitName' };
			
			const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: "" });

			// TUI Grid에 반영
			msDetailGrid.resetData(jsonData);
	   
	   	
			// 바로 서버에 저장 요청
			fetch('/ms/saveExcelData', {
			    method: 'POST',
			    headers: {
			        'Content-Type': 'application/json'
			    },
			    body: JSON.stringify(jsonData)
			})
			.then(res => {
			    if (!res.ok) throw new Error("저장 실패");
			    return res.text();
			})
			.then(data => {
			    Swal.fire({
			        icon: 'success',
			        title: '업로드 완료',
			        text: '엑셀 업로드 및 저장이 완료되었습니다.',
			        confirmButtonText: '확인'
			    });
			})
			.catch(err => {
			    console.error(err);
			    Swal.fire({
			        icon: 'error',
			        title: '저장 오류',
			        text: '엑셀 저장 중 오류가 발생했습니다.',
			        confirmButtonText: '닫기'
			    });
			});
			
			};

		reader.readAsArrayBuffer(file);
		
	});		
	
	
	
	
  	// grid 데이터 원본 저장
  	const originalData = grid.getData();

  	document.getElementById('searchInput').addEventListener('input', function (e) {
  	  const keyword = e.target.value.toLowerCase();

  	  // 원본 데이터를 기준으로 필터링
  	  const filtered = originalData.filter(row => {
  	    return Object.values(row).some(val => {
  	      if (val == null) return false;
  	      return String(val).toLowerCase().includes(keyword);
  	    });
  	  });

  	  // 필터링된 데이터로 그리드 업데이트
  	  grid.resetData(filtered);
  	});
  	
  	
  	function applyFilter() {
		  const keyword = document.getElementById('searchInput').value.toLowerCase();

		  let filtered = originalData;

		  if (keyword) {
		    filtered = filtered.filter(row =>
		      Object.values(row).some(val =>
		        val != null && String(val).toLowerCase().includes(keyword)
		      )
		    );
		  }

		  grid.resetData(filtered);
		}

  		document.getElementById('msSearchBtn').addEventListener('click', applyFilter);
		document.getElementById('searchInput').addEventListener('input', applyFilter);

	
	</script>
	
	</div>
</body>
</html>