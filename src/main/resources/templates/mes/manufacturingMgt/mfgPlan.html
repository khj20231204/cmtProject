<!DOCTYPE html>
	<html xmlns:th="http://www.thymeleaf.org" 
	      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
	      layout:decorate="~{layouts/layout}">
<head>
<meta charset="UTF-8">
	<title>CMT</title>
</head>
<body>
	<div layout:fragment="content">
	<h4>생산 계획</h4>
	
	<div class="card">
		<div class="card-body">
	    	<div class="row g-3 mb-4">
	        	<div class="col-md-3">
	        		<select id="mpStatus" name="" class="form-select">
						<option>상태</option>
						<option value="등록">등록</option>
						<option value="생산중">생산중</option>
						<option value="완료">완료</option>
						<option value="대기중">대기중</option>
						<option value="중단">중단</option>
						<option value="종료">종료</option>
	            	</select>
	            </div>
	            <div class="col-md-3">	
	                <input type="text" class="form-control" placeholder="수주코드를 입력해주세요.">  
	            </div>
	            <div class="col-md-2 d-flex align-items-end">
	            	<button type="button" class="btn btn-outline-secondary">
		            	<i class="bi bi-search"></i>
		            </button>
	            </div>
	            
	            <!-- 로그인한 사용자 ID -->
	            <input type="hidden" id="currentUserId" th:value="${#authentication.name}" />
	            
	            <div class="text-end mb-2">
		            <button type="button" id="updateBtn" class="btn btn-outline-secondary">저장</button>
		            <button type="button" id="delete" class="btn btn-outline-secondary">삭제</button>
		            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#mfgPlanModal">계획 등록</button>
	            </div>
	        </div>		
	    </div>

		<div id="mfgPlanGrid"></div>
	</div>
	
	<!--  모달 창 시작 -->
	<div class="modal fade" id="mfgPlanModal" tabindex="-1" aria-labelledby="mfgPlanModalLabel" aria-hidden="true">
	    <div class="modal-dialog modal-lg">
	        <div class="modal-content">
	            <div class="modal-header">
	                <h5 class="modal-title" id="mfgPlanModalLabel">생산 계획 등록</h5>
	                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
	            </div>
	            <div class="modal-body">
	            	<div id="soGrid"></div>
				</div>
	            <div class="modal-footer">
	                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
	                <button type="button" id="mfgPlanRegiBtn" class="btn btn-primary">등록</button>
		        </div>
	        </div> <!-- modal-content -->
	    </div><!-- modal-dialog modal-lg -->
	</div><!-- modal -->
	<!-- 모달 끝 -->
 
	<script th:inline="javascript">
	
	//================================== 그리드 부분 ================================= 
	let mpList = /*[[${mpList}]]*/ [];
	
	let grid1 = new tui.Grid({
        el: document.getElementById('mfgPlanGrid'), 
		data: mpList,
        rowHeaders: ['checkbox'],
		scrollX: true,
        scrollY: true,
		pageOptions: {
		   useClient: true,   // 클라이언트 사이드 페이징 사용
		   perPage: 10        // 페이지당 행 수
		 },
        columns: [
			{
				header: '생산계획번호',
				name: 'mpNo',
				width: 100,
				sortable: true, 
				filter: 'text',
				align: "center" 
            },
			{
				header: '생산계획코드',
				name: 'mpCode',
				width: 200,
				sortable: true, 
				filter: 'text',
				align: "center" 
            },
           {
                header: '수주코드',
                name: 'soCode',
				width: 200,
				sortable: true, 
				filter: 'text',
				align: "center" 
            },
			{
                header: '등록 직원명',
                name: 'empName',
				width: 200,
				fontSize: '40',
				sortable: true, 
				filter: 'text',
				align: 'center'
            },
            {
				header: '상태',
                name: 'mpStatus',
				width: 200,
				sortable: true, 
				filter: 'text',
				align: 'center',
				editor: "text"
            },
            {
				header: '우선순위',
                name: 'mpPriority',
				width: 200,
				sortable: true, 
				filter: 'text',
				align: 'center',
				editor: {
					type: "select",
					options: {
						listItems: [
							{ text: '높음', value: '높음' },
							{ text: '일반', value: '일반' },
							{ text: '낮음', value: '낮음' }
						]	
					}
				}
            },
			{
                header: '생산 시작 예정일',
                name: 'mpStartDate', 
				width: 200,
				sortable: true, 
				filter: 'text',
				align: 'center',
				editor: {
					type: 'datePicker',
					options: {
						format: 'yyyy-MM-dd'
					}
				}
            },
			{
                header: '생산 완료 예정일',
                name: 'mpEndDate',
				width: 200,
				sortable: true, 
				filter: 'text',
				align: 'center',
				editor: {
					type: 'datePicker',
					options: {
						format: 'yyyy-MM-dd'
					}
				}
            },
			{
                header: '등록일자',
                name: 'mpCreatedAt',
				width: 200,
				sortable: true, 
				filter: 'text',
				align: 'center',
				editor: {
					type: 'datePicker',
					options: {
						format: 'yyyy-MM-dd'
					}
				}
            },
			{
                header: '수정일자',
                name: 'mpUpdatedAt',
				width: 200,
				sortable: true, 
				filter: 'text',
				align: 'center',
				editor: {
					type: 'datePicker',
					options: {
						format: 'yyyy-MM-dd'
					}
				}
            }
        ], 
		autoEdit: true,
		editingEvent: 'dblclick' 
    });


	let soList = /*[[${soList}]]*/ [];
	console.log("-----------------확인", soList);
	let grid2 = null;
	
	let mpCode = "";
	
	document.getElementById('mfgPlanModal').addEventListener('shown.bs.modal', () => {
		
		const today = new Date().toISOString().slice(0, 10); // yyyy-MM-dd
		
		$.ajax({
			url: '/mfg/makeMpCode',
			method: 'GET',
			data: { data: today },
			success: function (code) {
				mpCode = code; // 등록 시 사용할 예정
				console.log("자동 생성된 MP 코드:", mpCode);
			},
			error: function () {
				alert("생산계획코드 자동 생성 실패");
			}
		});

		
		if (!grid2) {	
			grid2 = new tui.Grid({
				el: document.getElementById('soGrid'), 
				data : soList,
				rowHeaders: ['checkbox'],
				pageOptions: {
					useClient: true,
					perPage: 5
				},
				columns: [
					{
						header: '수주코드',
						name: 'soCode',
						align: "center"
					},
					{
						header: '제품코드',
						name: 'pdtCode',
						align: "center"
					},
					{
						header: '제품명',
						name: 'pdtName', 
						sortable: true,
						align: "center"
					},
					{
						header: '주문수량',
						name: 'soQty',
						sortable: true,
						align: "center"
					},
					{
						header: '주문단위',
						name: 'qtyUnitName',
						sortable: true,
						align: "center"
					},
					{
						header: '거래처명',
						name: 'cltName', 
						sortable: true,
						align: "center"
					},
					{
						header: '납품기한',
						name: 'soDueDate',
						sortable: true,
						align: "center"
					},
					{
						header: '소요시간',
						name: 'leadTime', 
						sortable: true,
						align: "center"
					},
					{
						header: '우선순위',
						name: 'mpPriority', 
						sortable: true,
						align: "center",
						editor: {
							type: "select",
							options: {
								listItems: [
									{ text: '높음', value: '높음' },
									{ text: '일반', value: '일반' },
									{ text: '낮음', value: '낮음' }
								]	
							}
						}
		            },
					{
						header: '생산 시작 예정일',
						name: 'mpStartDate', 
						sortable: true,
						align: "center",
						editor: {
							type: 'datePicker',
							options: {
								format: 'yyyy-MM-dd'
							}
						}
		            },
					{
						header: '생산 완료 예정일',
						name: 'mpEndDate', 
						sortable: true,
						align: "center",
						editor: {
							type: 'datePicker',
							options: {
								format: 'yyyy-MM-dd'
							}
						}
					},
					{
						header: '재고 조회',
						name: 'selectPdtQty', 
						sortable: true,
						align: "center",
						formatter: (pdtQty) => {
							 if (pdtQty.value === "등록 가능") {
							        return '<span class="text-success">' + pdtQty.value + '</span>';
							    } else if (pdtQty.value === "재고 부족") {
							        return '<span class="text-secondary">' + pdtQty.value + '</span>';
							    }
							    return '<button class="btn btn-warning btn-sm check-stock-btn">조회</button>';
						}
					}
				]
			});
		}
		
/* 		grid2.on('afterChange', (ev) => {
		    ev.changes.forEach(change => {
		        if (change.columnName === 'mpStartDate') {
		            const rowKey = change.rowKey;
		            const mpStartDateStr = change.value; // 입력된 생산 시작 예정일 (문자열)
		            const leadTimeHours = grid2.getValue(rowKey, 'leadTime'); // 소요시간 가져오기
		            console.log("DDDDD",leadTime);
		            
		            if (mpStartDateStr && leadTimeHours) {
		                const mpStartDate = new Date(mpStartDateStr);
		                const leadTimeDays = Math.ceil(leadTimeHours / 24); // 소요시간을 24로 나누어 일 수 계산
		                mpStartDate.setDate(mpStartDate.getDate() + leadTimeDays); // 날짜 더하기

		                const mpEndDateStr = mpStartDate.toISOString().split('T')[0]; // yyyy-MM-dd 포맷
		                grid2.setValue(rowKey, 'mpEndDate', mpEndDateStr); // 종료일 업데이트
		            }
		        }
		    });
		}); */
		
		
		grid2.on('click', (ev) => {
		    if (ev.columnName === 'selectPdtQty') {
		        const rowData = grid2.getRow(ev.rowKey);
		        
		        $.ajax({
		            url: '/mfg/selectCurrentQty',
		            type: 'GET',
		            data: {
		            	pdtCode: rowData.pdtCode,
		            	soQty: rowData.soQty
		            },
		            success: function(isAvailable) {
		                const newValue = isAvailable ? "등록 가능" : "재고 부족";
		                grid2.setValue(ev.rowKey, 'selectPdtQty', newValue);
		            },
		            error: function(xhr, status, error) {
		                console.error('재고 확인 중 오류:', error);
		            }
		        });
		    }
		});
		
	});	
	
	
	
	/*
	grid.on('onGridUpdated', (ev) => {
		// 그리드 레이아웃 새로고침 (로드가 다 되지 않는 경우 그리드가 흰색 화면으로 출력될 때가 있다.)
	    grid.refreshLayout();
	});*/
	
	
	
	//상품 계획 등록 시작 -------------------------------------------
	$('#mfgPlanRegiBtn').on('click', function () {
		const checkedRows = grid2.getCheckedRows(); // 선택된 행 가져오기
		const data = { ...checkedRows[0] };
		
		// 로그인한 유저
		data.empId = document.getElementById('currentUserId')?.value;
		
		// 자동 생성된 생산계획코드
		data.mpCode = mpCode;
		
		$.ajax({
			url: "/mfg/mfgPlanRegi",
			method : "POST",
			contentType: "application/json",
			data: JSON.stringify(data), // JSON 문자열로 전송
			success : function (response){
				alert(response);
				location.reload();
			},
			error : function (error){
				console.log(error);
			}
		})
	});
	// 상품 계획 등록 끝---------------------------------------------------------	
	
	// 상품 계획 수정
	$('#updateBtn').on('click', function () {
    const selectedRow = grid1.getCheckedRowKeys();
    
    const rowKey = selectedRow[0];
    const modifiedRow = grid1.getRow(rowKey);
    
	    $.ajax({
	        url: '/mfg/mfgPlanUpdate',
	        type: 'POST',
	        contentType: 'application/json',
	        data: JSON.stringify(modifiedRow),
	        success: function (msg) {
	            alert(msg);
	            location.reload();
	        },
	        error: function (err) {
	            alert("저장 실패");
	            console.log(err);
	        }
	    });
	});
	
	// 상품 계획 삭제
	$('#delete').on('click', function () {
    const selectedRowKeys = grid1.getCheckedRowKeys();
    
    if (selectedRowKeys.length === 0) {
        alert("삭제할 항목을 선택해주세요.");
        return;
    }

    const rowKey = selectedRowKeys[0];
    const mpCode = grid1.getValue(rowKey, 'mpCode');
    
    if (!confirm("정말 삭제하시겠습니까?")) return;

	    $.ajax({
	        url: '/mfg/mfgPlanDelete',
	        type: 'POST',
	        contentType: 'application/json',
	        data: JSON.stringify([mpCode]),
	        success: function (msg) {
	            alert(msg);
	            location.reload();
	        },
	        error: function (err) {
	            alert("삭제 실패");
	            console.log(err);
	        }
	    });
	});

	
	
	</script>
	
	</div>
</body>
</html>