<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
    

<mapper namespace="com.example.cmtProject.mapper.mes.qualityControl.FqcMapper">

	<select id="getAllFqc" resultType="com.example.cmtProject.dto.mes.qualityControl.FqcDTO">
	SELECT 
        F.FQC_NO,
        F.FQC_CODE,
        E.EMP_NAME,
        E.EMP_ID,
        F.QCM_NAME,
        P.PDT_NAME,
        F.FQC_START_TIME,
        F.FQC_END_TIME,
        F.ISSUED_QTY,
        F.UNIT_QTY,
        F.FQC_MEASURED_WEIGHT_VALUE,
        F.FQC_MEASURED_LENGTH_VALUE,
        C_UNIT_LENGTH.CMN_DETAIL_NAME AS QCM_UNIT_LENGTH,
		C_UNIT_WEIGHT.CMN_DETAIL_NAME AS QCM_UNIT_WEIGHT,
		F.FQC_INSPECTION_STATUS,
		F.FQC_INSPECTION_RESULT,
        F.WHS_NAME,
        F.LOT_NO,
        F.FQC_REMARKS,
        F.ISSUE_CODE
    FROM FQC F
    LEFT JOIN COMMONCODE_DETAIL C_UNIT_LENGTH ON C_UNIT_LENGTH.CMN_DETAIL_NAME = F.QCM_UNIT_LENGTH
	LEFT JOIN COMMONCODE_DETAIL C_UNIT_WEIGHT ON C_UNIT_WEIGHT.CMN_DETAIL_NAME = F.QCM_UNIT_WEIGHT	
	JOIN EMPLOYEES E ON E.EMP_ID = F.EMP_ID
	JOIN PRODUCTS P ON P.PDT_CODE = F.PDT_CODE
	WHERE F.FQC_VISIABLE = 'Y'
    ORDER BY FQC_NO DESC
	</select>
	
	<!-- 비고란 업데이트 -->
	<update id="fqcRemarksUpdate" parameterType="com.example.cmtProject.dto.mes.qualityControl.FqcDTO">
		UPDATE FQC
		SET FQC_REMARKS = #{fqcRemarks}
		WHERE FQC_NO = #{fqcNo}
	</update>
	
	<!-- 삭제 대신 안보이게 업데이트 -->
	<update id="isVisiableToFalse" parameterType="list">
	  UPDATE FQC
	  SET FQC_VISIABLE = 'N'
	  WHERE FQC_NO IN (
	    <foreach item="id" collection="list" separator=",">
	      #{id}
	    </foreach>
	  )
	</update>
	
	
	<!-- 엑셀 데이터 업데이트 -->
	<update id="saveExcelData" parameterType="com.example.cmtProject.dto.mes.qualityControl.FqcDTO">
		UPDATE FQC
	    SET
	        FQC_INSPECTION_STATUS       = #{fqcInspectionStatus},
	        FQC_INSPECTION_RESULT       = #{fqcInspectionResult},
	        FQC_CODE                    = #{fqcCode},
	        QCM_NAME                    = #{qcmName},
	        EMP_NAME                    = #{empName},
	        EMP_ID                      = #{empId},
	        PDT_NAME                    = #{pdtName},
	        ISSUED_QTY                  = #{issuedQty},
	        UNIT_QTY                    = #{unitQty},
	        FQC_MEASURED_WEIGHT_VALUE   = #{fqcMeasuredWeightValue},
	        QCM_UNIT_WEIGHT             = #{qcmUnitWeight},
	        FQC_MEASURED_LENGTH_VALUE   = #{fqcMeasuredLengthValue},
	        QCM_UNIT_LENGTH             = #{qcmUnitLength},
	        FQC_START_TIME              = #{fqcStartTime},
	        FQC_END_TIME                = #{fqcEndTime},
	        WHS_NAME                    = #{whsName},
	        FQC_REMARKS                 = #{fqcRemarks}
	    WHERE FQC_NO = #{fqcNo}
	</update>
	
	
	<!-- 물건 출고시 출고 검사 검사전과 필요한 데이터 가져오기 -->
	<select id="getProductsIssues" resultType="map">
		SELECT 
			ISSUE_CODE,
			PDT_CODE,
			ISSUED_QTY,
			WAREHOUSE_CODE
		FROM
			PRODUCTS_ISSUE
		WHERE ISSUE_CODE = #{issueCode}
	</select>
	
	<!-- FQC CODE 생성 및 최대값 가져오는 코드 -->
	<select id="getMaxFqcCodeSeq" resultType="int" parameterType="string">
	  SELECT 
	    COALESCE(MAX(TO_NUMBER(SUBSTR(FQC_CODE, 14))), 0)
	  FROM 
	    FQC
	  WHERE 
	    SUBSTR(FQC_CODE, 5, 8) = #{datePart}
	</select>

	<!-- 출고가 되기전 검사 시작 눌렀을시 저장될 데이터들 -->
	<insert id="insertFqcInspectionList" parameterType="map">
	INSERT INTO FQC (
	  FQC_INSPECTION_STATUS,
	  FQC_INSPECTION_RESULT,
	  FQC_CODE, 
	  RECEIPT_CODE,
	  PDT_CODE, 
	  ISSUE_QTY, 
	  UNIT_QTY,
	  WHS_CODE,
	  FQC_VISIABLE
	)
	SELECT
	  '검사전',
	  '예정',
	  #{fqcCode},
	  #{issueCode}, 
	  #{pdtCode}, 
	  #{issuedQty},
	  '개',
	  #{whsCode},
	  'Y'
	FROM DUAL
	WHERE NOT EXISTS (
	  SELECT 1 FROM FQC WHERE ISSUE_CODE = #{issueCode}
	)
	</insert>
	
	<!-- 검사전에서 검사중으로 업데이트 -->
	<update id="updateFqcInspectionStatusProcessing" parameterType="map">
		UPDATE FQC
		SET 
			FQC_INSPECTION_STATUS = '검사중',
			EMP_NAME = #{emp.empName},
			EMP_ID = #{emp.empId},
			FQC_START_TIME = #{fqc.fqcStartTime}
		WHERE FQC_CODE = #{fqc.fqcCode}
	</update>
	


</mapper>